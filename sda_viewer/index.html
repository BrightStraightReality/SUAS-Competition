<!DOCTYPE html>
<html lang="en"> <!-- <html lang="en" manifest="rsc/misc/main.appcache"> -->
	<head>
		<meta charset="utf-8">

		<title>Viewer: The Second</title>
		<meta name="description" content="Loads custom map files as demonstration of an offline web-based viewer that displays the position of our drone, obstacles, and the flight zone.">
		<meta name="author" content="FHS:SUAS">

		<script type="text/javascript" src="rsc/js/jquery.3.1.1.min.js"></script>

		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
		<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
		<!--<script src="rsc/js/PBFParser.js"></script>-->

		<style type="text/css">
			#mapid { height:100vh; }
			html, body {
				font-family:'Arial',sans-serif,serif;
				overflow-y:hidden;
				margin:0;
			}
			td {
				font-size:1.03em;
				padding:4px 0;
			}
			.shadow {
				-webkit-box-shadow:6px 6px 0px 0px rgba(0,0,0,0.54);
				-moz-box-shadow:6px 6px 0px 0px rgba(0,0,0,0.54);
				box-shadow:6px 6px 0px 0px rgba(0,0,0,0.54);
			}
			.window {
				width:100%;
				height:100vh;
			}
			.status {
				z-index:1000 !important;
				background-color:white;
				position:absolute;
				top:8px;
				right:12px;
				border:4px solid black;
				padding:4px;
				width:350px;
			}
			.num {
				font-size:2.5em !important;
			}
			.obstacle {
				position:absolute;
				z-index:1000 !important;
				background-color:#e74c3c;
				color:#ecf0f1;
				width:450px;
				height:110px;
				top:25px;
				margin:0 auto;
				left:0;
				right:0;
				padding:16px;
				font-family:"Consolas","Inconsolata",sans-serif;
				font-size:1.9em;
				-moz-box-sizing:border-box; 
				-webkit-box-sizing:border-box; 
				box-sizing:border-box;

				-webkit-animation: flash 1s linear infinite;
				-moz-animation: flash 1s linear infinite;
				animation: flash 1s linear infinite;
			}
			@-webkit-keyframes flash {
				0% { border:3px solid black; }
				100% { border:3px solid red; }
			}â€‹
			@-moz-keyframes flash {
				0% { border:3px solid black; }
				100% { border:3px solid red; }
			}
			@keyframes flash {
				0% { border:3px solid black; }
				100% { border:3px solid red; }
			}
			.g-button {
				width:100%;
				height:38px
			}
			.SvgOverlay svg {
				position:absolute;
				top:-4000px;
				left:-4000px;
				width:8000px;
				height:8000px;
			}
			#droneSymbol {
				position:absolute;
			}
			#dropdown {
				cursor:pointer;
				padding:5px 8px;
				border-radius:5px;
				display:inline-block;
			}
			#dropdown:hover {
				background-color:#95a5a6;
			}
			.inline {
				margin-bottom:4px;
			}
			fieldset {
				border:1px solid black;
				background-color:rgba(0,0,0,0.09);
			}
			legend {
				background-color:#fff;
			}
			label {
				display:block;
				position:relative;
				padding-left:40px; /* adjust if necessary */
			}
			label > span {
				position:absolute;
				left:0;
			}
			.hidden {
				display:none;
			}
			.noselect {
				-webkit-touch-callout:none;
				-webkit-user-select:none;
				-khtml-user-select:none;
				-moz-user-select:none;
				-ms-user-select:none;
				user-select:none;
			}
		</style>

		<!--[if lt IE 9]>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
		<![endif]-->
	</head>
	<body>
		<div id="mapid"></div>
		<div id="warning" class="obstacle shadow hidden">
			<center>
				<b><u>! OBSTACLE DETECT !</u></b><br>
				<span style="font-size:0.75em">Object avoidance now activated.</span>
			</center>
		</div>
		<div class="status shadow">
			<center style="font-size:2.2em"><u>FlintHill: SDA</u></center>
			<center><div class="noselect" id="dropdown" onclick="rips()">Show Description</div></center>
			<div id="information" style="font-size:1.05em">
				<fieldset>
			    	<legend><u>Description:</u></legend>
					This is a web-based, live view of the drone's position and current obstacles. Like Mission Planner, this page displays all the relevant information such as altitude, direction, and speed in multiple directions. But this page also includes obstacle visualization and avoidance trajectories on a 2D plane.
				</fieldset>
				<fieldset>
			    	<legend><u>How it works:</u></legend>
					<ol style="margin:0 auto">
						<li>Disregards any obstacle not within 15 feet of our current altitude.</li>
						<li>Calculates the current, straight trajectory of our drone and any intersections with other obstacles, whether they be stationary or moving.</li>
						<li>If a collision is imminent, the drone either:
							<ul>
								<li>Climbs to a new, higher altitude.</li>
								<li>Stops and stay in the same position.</li>
							</ul>
						</li>
						<li>Repeats.</li>
					</ol>
				</fieldset>
			</div>
			<div style="font-size:1.05em">
				<script type="text/javascript">
					function sleep(milliseconds) {
						var start = new Date().getTime();
						for (var i = 0; i < 1e7; i++) {
							if ((new Date().getTime() - start) > milliseconds){
								break;
							}
						}
					}

					// websocket
					function doConnect() {
						console.log("Launching websocket connection to 'ws://" + $("#url").val() + ":8000/'")
						websocket = new WebSocket("ws://" + $("#url").val() + ":8000/");
						websocket.onopen = function(evt) { onOpen(evt) };
						websocket.onmessage = function(evt) { onMessage(evt) };
						websocket.onclose = function(evt) { onClose(evt) };
					};
					function doDisconnect() {
						console.log("WebSocket DISCONNECT");
						websocket.close();
					};
					function doPause() {
						console.log("This functionality has not been implemented yet.");
					};

					function screwMeUp() {
						$.when($.when($.when($.when($.when().then()).then()).then()).then()).then(console.log("shamrock shakes"));
						return null;
					}

					// interop server
					var waypoints = [], waypoints_line = null, waypoints_latlngs = [], search_grid_points = [], search_grid_line = null, search_grid_latlngs = [];

					var fly_zone_line = null, fly_zone_latlngs = [];

					var air_drop_pos_point = null, emergent_last_know_pos_point = null, home_pos_point = null, off_axis_target_pos_point = null;

					function markersDo(action) {
						console.log("markersDo('" + action + "')");

						switch(action) {
							case "clear":
								// clears variables
								waypoints.length = 0;
								waypoints_latlngs.length = 0;
								waypoint_line = null;

								search_grid_points.length = 0;
								search_grid_latlngs.length = 0;
								search_grid_line.length = 0;

								fly_zone_line = null;
								fly_zone_latlngs.length = 0;
								break;
							case "addTo":
								waypoints.forEach(function(element) {
									element.addTo(mymap);
								});
								search_grid_points.forEach(function(element) {
									element.addTo(mymap);
								})

								air_drop_pos_point.addTo(mymap);
								emergent_last_known_pos_point.addTo(mymap);
								home_pos_point.addTo(mymap);
								off_axis_target_pos_point.addTo(mymap);
								//waypoints_line.forEach(function(element) {
								//	element.addTo(mymap);
								//})
								break;
							case "remove":
								// removes from leaflet map
								if(waypoints.length !== 0) {
									waypoints.forEach(function(element) { element.remove(); });
									waypoints_line.remove();

									search_grid_points.forEach(function(element) { element.remove(); })
									search_grid_line.remove();

									fly_zone_line.remove();

									air_drop_pos_point.remove();
									emergent_last_known_pos_point.remove();
									home_pos_point.remove();
									off_axis_target_pos_point.remove();

									markersDo('clear');
								} else {
									console.log("Not clearing all points and lines because they're already empty");
								}
								break;
							default:
								throw "Unsupported markersDo(action) action: '" + action + "'";
						}

						return true;
					}

					function pullMissionInfo() {
						if(interopEndpointURL == "") {
							alert("You've been disconnected from the Interop server.");
							console.log("Disconnected, no longer polling interop server");
							return;
						}

						$.ajax({
							url: (interopEndpointURL + "missions/"),
							async: true, method: "GET",
							xhrFields: {withCredentials: true},

							success: function(data, status, xhr) {
								console.log("SessionID works!");
								console.log(data);

								/* draw on map: 
								 * - fly_zone..................// red border, no fill
								 * - air_drop_pos..............// marker, red
								 * - emergent_last_known_pos...// marker, blue
								 * - home_pos..................// marker, green
								 * - off_axis_target_pos.......// marker, purple
								 * - mission_waypoints.........// markers, yellow. all markers connected with solid yellow line.
								 * - search_grid_points........// markers, green. all " connected with 'stroke dash pattern' green line.
								 *
								 * needs a seperate request for obstacles
								 */

								if(waypoints.length == 0) {
									console.log("Setting up markers...");
									///////// setup

									// mission_waypoints.........// markers, yellow. all markers connected with solid yellow line
									// search_grid_points........// markers, green. all " connected with 'stroke dash pattern' green line
									waypoints_latlngs = [];
									search_grid_latlngs = [];
									fly_zone_latlngs = [];

									for(var i = 0; i < data[0]["mission_waypoints"].length; i++) {
										// MISSION WAYPOINTS
										var mission_location = [data[0]["mission_waypoints"][i].latitude, data[0]["mission_waypoints"][i].longitude];

										waypoints[i] = L.marker(mission_location, {icon: Icon_markerYellow, title: 'Waypoint #' + data[0]["mission_waypoints"][i].order});

										waypoints_latlngs.push(mission_location);
									}

									for(var i = 0; i < data[0]["search_grid_points"].length; i++) {
										// SEARCH GRID POINTS
										var search_grid_location = [data[0]["search_grid_points"][i].latitude, data[0]["search_grid_points"][i].longitude];

										search_grid_points[i] = L.marker(search_grid_location, {icon: Icon_searchPoint, title: 'Search Point #' + data[0]["search_grid_points"][i].order});
										search_grid_latlngs.push(search_grid_location);
									}

									for(var i = 0; i < data[0]["fly_zones"][0]["boundary_pts"].length; i++ ) {
										var fly_zone_location = [data[0]["fly_zones"][0]["boundary_pts"][i].latitude, data[0]["fly_zones"][0]["boundary_pts"][i].longitude];

										fly_zone_latlngs.push(fly_zone_location);
									}
									fly_zone_latlngs.push([data[0]["fly_zones"][0]["boundary_pts"][0].latitude, data[0]["fly_zones"][0]["boundary_pts"][0].longitude]);

									waypoints_line = L.polyline(waypoints_latlngs, {color: 'yellow', interactive: false}).addTo(mymap);
									search_grid_line = L.polyline(search_grid_latlngs, {color: 'green', interactive: false}).addTo(mymap);
									fly_zone_line = L.polyline(fly_zone_latlngs, {color: 'red', weight: 9, opacity: 0.8, interactive: false}).addTo(mymap);

									// var air_drop_pos_point = null, emergent_last_know_pos_point = null, home_pos_point = null, off_axis_target_pos_point = null;

									air_drop_pos_point = L.marker(
										[
											data[0]["air_drop_pos"].latitude, 
											data[0]["air_drop_pos"].longitude
										], 
										{icon: Icon_markerRed, title: 'Air Drop Position'}
									);

									emergent_last_known_pos_point = L.marker(
										[
											data[0]["emergent_last_known_pos"].latitude, 
											data[0]["emergent_last_known_pos"].longitude
										], 
										{icon: Icon_markerBlue, title: 'Emergent Target Last Known Position'}
									);

									home_pos_point = L.marker(
										[
											data[0]["home_pos"].latitude, 
											data[0]["home_pos"].longitude
										], 
										{icon: Icon_markerGreen, title: 'Home'}
									);

									off_axis_target_pos_point = L.marker(
										[
											data[0]["off_axis_target_pos"].latitude, 
											data[0]["off_axis_target_pos"].longitude
										], 
										{icon: Icon_markerPurple, title: 'Off Axis Target Position'}
									);

									markersDo("addTo");
								} else {
									console.log("Updating markers...");
									///////// update

									// mission_waypoints.........// markers, yellow. all markers connected with solid yellow line
									// search_grid_points........// markers, green. all " connected with 'stroke dash pattern' green line
									waypoints_latlngs = [];
									search_grid_latlngs = [];
									fly_zone_latlngs = [];

									for(var i = 0; i < data[0]["mission_waypoints"].length; i++) {
										// MISSION WAYPOINTS
										var mission_location = [data[0]["mission_waypoints"][i].latitude, data[0]["mission_waypoints"][i].longitude];

										if(typeof waypoints[i] !== 'undefined') 
											waypoints[i].setLatLng(mission_location);
										else if(waypoints[i] === null)
											waypoints[i].remove();
										else
											waypoints[i] = L.marker(mission_location, {icon: Icon_markerYellow, title: 'Waypoint #' + data[0]["mission_waypoints"][i].order});
										
										waypoints_latlngs.push(mission_location);
									}

									for(var i = 0; i < data[0]["search_grid_points"].length; i++) {
										var search_grid_location = [data[0]["search_grid_points"][i].latitude, data[0]["search_grid_points"][i].longitude];

										if(typeof search_grid_points[i] !== 'undefined')
											search_grid_points[i].setLatLng(search_grid_location);
										else if(search_grid_points[i] === null)
											search_grid_points[i].remove();
										else
											search_grid_points[i] = L.marker(mission_location, {icon: Icon_searchPoint, title: 'Search Point #' + data[0]["mission_waypoints"][i].order});

										search_grid_latlngs.push(search_grid_location);
									}

									for(var i = 0; i < data[0]["fly_zones"][0]["boundary_pts"].length; i++ ) {
										var fly_zone_location = [data[0]["fly_zones"][0]["boundary_pts"][i].latitude, data[0]["fly_zones"][0]["boundary_pts"][i].longitude];

										fly_zone_latlngs.push(fly_zone_location);
									}
									fly_zone_latlngs.push([data[0]["fly_zones"][0]["boundary_pts"][0].latitude, data[0]["fly_zones"][0]["boundary_pts"][0].longitude]);

									waypoints_line.remove();
									search_grid_line.remove();
									fly_zone_line.remove();

									waypoints_line = L.polyline(waypoints_latlngs, {color: 'yellow', interactive: false}).addTo(mymap);
									search_grid_line = L.polyline(search_grid_latlngs, {color: 'green', interactive: false}).addTo(mymap);
									fly_zone_line = L.polyline(fly_zone_latlngs, {color: 'red', weight: 4.5, opacity: 0.8, interactive: false}).addTo(mymap);

									//marks instanceof L.Marker
								}
							},
							error:function(textStatus) {
								alert("Interop Server returned an error code, the stated reason is: " + textStatus);
								console.log("Interop Fail, Status: " + textStatus);
							}
						});
						setTimeout('pullMissionInfo()', 4000);
					}

					var interopEndpointURL = "";

					function interopConnect() {
						interopEndpointURL = "http://" + $("#address").val() + ":8888/" + $("#endpointURL").val();

						console.log(interopEndpointURL);

						$.when($.ajax({
							url: (interopEndpointURL + "login/"),
							async: true, cache: false, method: "POST", crossDomain: true,
							data: {"username":$("#username").val(), "password":$("#password").val()},

							statusCode: {
								400: function(textStatus) {
									alert(textStatus.responseText);
								}
							},

							success:function(data) { // success or error for "complete"s
								console.log(data);
							},
							error:function(textStatus) {
								console.log("Failed to connect to interop server at: http://" + $("#address").val() + ":8888/" + $("#endpointURL").val());
								console.log(textStatus);
							}
						})).then(function() {
							pullMissionInfo();
						})
					};
					function interopDisconnect() {
						if(interopEndpointURL == "")
							alert("You're not connected.");
						else
							interopEndpointURL = "";
					};

					function onOpen(evt) {
						// constantly request new information from the server
						console.log("Connected to websocket.");

						setInterval(function(){
							console.log("Requested update");
							websocket.send("update");
							// add in disconnect functionality
							// http://stackoverflow.com/questions/16437173/stop-setinterval
						}, 3000);
					}
					function onMessage(evt) {
						// update positions of obstacles
						if(JSON.parse(evt.data).obstacle_present == true)
							$("#warning").removeClass("hidden");
						else
							$("#warning").addClass("hidden");

						$("#alt").html((JSON.parse(evt.data).alt).toFixed(2));
						$("#dir").html((JSON.parse(evt.data).dir).toFixed(2));
						$("#speed").html((JSON.parse(evt.data).speed).toFixed(2));
						$("#vert_speed").html((JSON.parse(evt.data).vert_speed).toFixed(2));
					}
					function onClose(evt) {
						console.log("Disconnected from websocket.");
					}
				</script>
				<fieldset>
			    	<legend><u>Interop Server:</u></legend>
					<form name="connect" id="conn">
						<div style="padding:0 2px">
							<div class="inline">
								<label for="url"><span class="noselect">http://</span><input type="text" id="address" style="width:26%" value="localhost">&nbsp;:8888/&nbsp;<input type="text" id="endpointURL" style="width:48%" value="interop/api/"></label>
							</div>
							<input type="text" id="username" style="width:46%" placeholder="Username">
							<input type="text" id="password" style="width:46%;float:right;" placeholder="Password">
						</div>
						<div style="margin-top:6px">
							<input type="button" class="g-button" onclick="interopConnect();" value="CONNECT">
						</div>
						<div style="margin-top:6px">
							<input type="button" class="g-button" onclick="interopDisconnect();markersDo('remove');" value="DISCONNECT">
						</div>
					</form>
				</fieldset>
				<fieldset style="padding-bottom:6px;">
			    	<legend><u>GroundControl Websocket:</u></legend>
					<form name="connect" id="conn">
						<div style="padding:0 2px">
							<div class="inline">
								<label for="url"><span class="noselect">ws://</span><input type="text" id="url" style="width:76%"value="127.0.0.1">&nbsp;:8000/</label>
							</div>
							<input type="button" class="g-button" onclick="doConnect()" value="CONNECT">
						</div>
						<table style="width:100%">
							<col width="50%">
							<col width="50%">
							<tr>
								<td>
									<input type="button" class="g-button" onclick="doDisconnect()" value="DISCONNECT">
								</td>
								<td>
									<input type="button" class="g-button" onclick="doPause()" value="PAUSE">
								</td>
							</tr>
						</table>
					</form>
				</fieldset>
			</div>
			<hr>
			<center><u>Flight Instruments:</u></center>
			<table border="1" style="width:100%;text-align:center;margin:8px 0">
				<col width="50%">
				<col width="50%">
				<tr>
					<td>
						<b><div class="num" id="alt">N/a</div></b>
						Altitude (feet)
					</td>
					<td>
						<b><div class="num" id="dir">N/a&deg;</div></b>
						Direction (mag)
					</td>
				</tr>
				<tr>
					<td>
						<b><div class="num" id="speed">N/a</div></b>
						Speed (m/s)
					</td>
					<td>
						<b><div class="num" id="vert_speed">N/a</div></b>
						Vertical Speed (m/s)
					</td>
				</tr>
			</table>
			<div style="font-family:Consolas,Inconsolata,sans-serif,serif;text-align:center;font-style:italic;">v0.1 BETA EDUCATIONAL</div>
		</div>
		<script type="text/javascript">
			var mymap = L.map('mapid').setView([38.9012, -77.2653], 5);

			L.tileLayer('rsc/tiles/virginia-latest.osm.pbf');

			// interface
			function rips() {
				if( $("#information").css("display") == "block" ) {
					$("#information").css("display", "none");
					$("#dropdown").text("Show Description"); // &uarr;
				} else {
					$("#information").css("display", "block");
					$("#dropdown").text("Show Description"); // &darr;
				}
			};

			/*
			L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
				maxZoom: 18,
				attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
					'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
					'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
				id: 'mapbox.streets'
			}).addTo(mymap);
			*/

			iS = [32, 32]; iA = [iS[0]/2, iS[1]]; pA = [0, iS[0]];

			// TODO: Add retina version of markers
			var Icon_markerRed = L.icon({
				iconUrl: 'rsc/img/icons/128-map-marker-red.png',
				iconSize: iS,
				iconAnchor: iA,
				popupAnchor: pA
			});
			var Icon_markerBlue = L.icon({
				iconUrl: 'rsc/img/icons/128-map-marker-blue.png',
				iconSize: iS,
				iconAnchor: iA,
				popupAnchor: pA
			});
			var Icon_markerGreen = L.icon({
				iconUrl: 'rsc/img/icons/128-map-marker-green.png',
				iconSize: iS,
				iconAnchor: iA,
				popupAnchor: pA
			});
			var Icon_markerPurple = L.icon({
				iconUrl: 'rsc/img/icons/128-map-marker-purple.png',
				iconSize: iS,
				iconAnchor: iA,
				popupAnchor: pA
			});
			var Icon_markerYellow = L.icon({
				iconUrl: 'rsc/img/icons/128-map-marker-yellow.png',
				iconSize: iS,
				iconAnchor: iA,
				popupAnchor: pA
			});

			var Icon_searchPoint = L.icon({
				iconUrl: 'rsc/img/icons/128-map-search-green.png',
				iconSize: iS,
				iconAnchor: [iS[0]/2, iS[1]/2],
				popupAnchor: [0, 32]
			});

			L.tileLayer('http://10.43.0.66/sda_viewer/tile/{z}/{x}/{y}.png', {
				maxZoom: 18,
				attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
					'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
					'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
				id: 'mapbox.streets'
			}).addTo(mymap);
		</script>
	</body>
</html>